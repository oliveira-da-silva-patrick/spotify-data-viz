Activate renv environment.

```{r}
renv::activate()
```

Load the libraries.

```{r}
library(tidyverse)
library(spotifyr)
```

Initialise and setup the environment.

```{r}
theme_set(theme_minimal(base_size = 14))

artists_af <- read_csv("../data/top_artists_with_audio_features.csv")
hist2023 <- read.csv("../data/Streaming_History_2023.csv")
raw <- read.csv("../data/Streaming_2023_Raw.csv")

artists_genre <- artists_af |>
  select(artist_name, genres) |>
  distinct()

data <- hist2023 |>
  filter(master_metadata_album_artist_name %in% pull(artists_genre, artist_name)) |>
  left_join(artists_genre, 
            by = join_by(master_metadata_album_artist_name == artist_name),
            multiple = "all")

top_genres <- data |>
  count(genres, sort = TRUE) |>
  head(10) |>
  pull(genres)
```

Let's connect to Spotify.

```{r}
Sys.setenv(SPOTIFY_CLIENT_ID = '50a6babd1746400f9de5a5a6ddf2b870')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '290ce59c9b10458987bf608c2ee732bb')

authorization_code <- get_spotify_authorization_code(
                        scope = scopes()[c(4,7,8,9,10,14,15,17)])
```

Explore what my Spotify history and deduce what we can figure out.
I bought a new phone in July.

```{r}
hist2023 |>
  mutate(month = month(date)) |>
  count(month, platform) |>
  ggplot(aes(x = month, y = n, fill = platform)) +
  geom_col() +
  scale_fill_manual(values=c("android"="#A4C639", "windows"="#3778BF",
                             "ios" = "#7D7D7D", "osx" = "#A6109F")) +
  labs(title = "How many songs did I listen on each platform each month?",
       y = element_blank(),
       x = element_blank()) +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank())
```

```{r}
hist2023 |>
  mutate(month = month(date),
         day = day(date),
         wday = wday(date, label = TRUE),
         hour = hour(hms(time))) |>
  filter(month == 11 & day <= 19 & day >= 13) |>
  count(wday, hour, platform) |>
  ggplot(aes(x = hour, y = wday, colour = platform)) +
  geom_point(aes(size = 8)) +
  scale_color_manual(values=c("android"="#A4C639", "windows"="#3778BF",
                             "ios" = "#7D7D7D", "osx" = "#A6109F")) +
  labs(title = "Spotify activity during the week of the 13/11 - 19/11",
       y = element_blank(),
       x = element_blank()) +
  theme(legend.position = "none") + 
  scale_x_continuous(breaks = seq(0, 23, 1))
```


```{r}
hist2023 |>
  mutate(month = month(date),
         day = day(date),
         wday = wday(date, label = TRUE),
         hour = hour(hms(time))) |>
  filter(month == 11 & day <= 26 & day >= 20) |>
  count(wday, hour, platform) |>
  ggplot(aes(x = hour, y = wday, colour = platform)) +
  geom_point(aes(size = 8)) +
  scale_color_manual(values=c("android"="#A4C639", "windows"="#3778BF",
                             "ios" = "#7D7D7D", "osx" = "#A6109F")) +
  labs(title = "Spotify activity during the week of the 20/11 - 26/11",
       y = element_blank(),
       x = element_blank()) +
  theme(legend.position = "none") + 
  scale_x_continuous(breaks = seq(0, 23, 1))
```

By looking at the times the different platforms are used or when no music is
being listened to, one can figure out a schedule.

Let's take a look now at what we can learn about different genres to see if we
can also figure something out about my listening habits.

```{r}
data |>
  filter(genres %in% top_genres) |>
  ggplot(aes(y = fct_rev(fct_infreq(genres)))) +
  geom_bar()
```

I am surprised by how much one can figure out about the user by 
looking at the user data. However, the songs are a bit more cryptic about their
genres. Spotify decided to only give artists genres. This sounds to be
chaotic as one might think that genres are defined by the audio features you
can access through their API. Actually, there's more behind it. After reading
a paper about how machine learning is used to figure out sounds, I learned 
that the audio features are not enough. They do describe the song but there is
a lot that can not be described with them alone.

